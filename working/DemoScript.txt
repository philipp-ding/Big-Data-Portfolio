# Enable ingress addon
minikube addons  enable ingress

# Set docker build context to minikube
eval $(minikube docker-env)

# Build the application's image
mkdir app ; cd app
docker build -t my-super-web-app .

# Run the app
kubectl apply -f 01-mariadb-deployment.yaml
kubectl apply -f 02-k8s-mariadb-service.yaml
kubectl apply -f 03-memcached-deployment-and-service.yaml
kubectl apply -f code/k8s-demo-app/04-app-deployment-minikube.yaml
kubectl apply -f code/k8s-demo-app/04-app-service-and-ingress.yaml

# Check it's running 
kubectl port-forward service/my-super-app-service 8080:8080
watch kubectl get all
watch kubectl get ingress -o wide
curl http://`minikube ip`/person/l.mlb.com-p.7491

# Scale memcached
kubectl scale deployment memcache-deployment --replicas=2 ; watch kubectl get all
curl http://`minikube ip`/person/l.mlb.com-p.7491

# Scale the app
kubectl scale deployment my-super-app-deployment --replicas=2 ; watch kubectl get all
curl http://`minikube ip`/person/l.mlb.com-p.7491

# Delete the app
kubectl delete deployment/memcache-deployment
kubectl delete deployment/my-super-app-deployment
kubectl delete deployment/mariadb-deployment
kubectl delete svc/my-super-app-service
kubectl delete svc/my-memcached-service
kubectl delete svc/my-app-mariadb-service
kubectl delete ingress/my-super-app-ingress
watch kubectl get all